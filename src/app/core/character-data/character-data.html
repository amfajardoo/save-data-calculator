<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl space-y-4 mt-4">
  <div
    class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center border-b border-gray-700 pb-3 gap-2"
  >
    <input
      type="text"
      [ngModel]="character().name"
      (ngModelChange)="updateCharacter('name', $event)"
      class="text-xl font-bold bg-transparent border-none outline-none focus:ring-1 focus:ring-purple-400 rounded p-1 -m-1"
    />
    <div class="text-3xl font-extrabold text-purple-400">
      Total FM: {{ character().score }} / {{ totalCap() }}
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-2 space-y-6">
      <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
        <h3 class="text-lg font-semibold mb-3 text-purple-300">
          Deck Actual
          <span class="text-sm text-gray-500 font-normal ml-2"
            >({{ character().deck.length }} Cartas)</span
          >
        </h3>

        @if (character().deck.length === 0) {
          <button
            (click)="addInitialCards()"
            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition font-medium"
          >
            ‚ûï A√±adir todas las cartas iniciales
          </button>
        } @else {
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            @for (card of character().deck; track card.id; let index = $index) {
              @let status = getEpiphanyStatus(card);

              @if (card.type === 'FORBIDDEN' || card.type === 'NEUTRAL') {
                <div
                  class="p-3 rounded-lg relative group transition border"
                  [class.bg-red-800]="card.type === 'FORBIDDEN'"
                  [class.border-red-600]="card.type === 'FORBIDDEN'"
                  [class.bg-gray-700]="card.type === 'NEUTRAL'"
                  [class.border-gray-600]="card.type === 'NEUTRAL'"
                >
                  <span class="font-bold text-sm" [class.text-red-300]="card.type === 'FORBIDDEN'">
                    {{ card.type === 'FORBIDDEN' ? 'Prohibida' : 'Neutral' }}
                  </span>
                  <span class="block text-xs text-gray-400"
                    >+{{ FAINT_MEMORY_CONTRIBUTION[card.type] }} FM</span
                  >
                  <div class="flex gap-2 mt-2">
                    <button
                      (click)="removeDeckCard(card.id)"
                      class="flex-1 text-xs bg-red-800 hover:bg-red-700 rounded px-2 py-1"
                    >
                      Remover
                    </button>
                    <button
                      (click)="duplicateCard(card.id)"
                      class="flex-1 text-xs bg-purple-700 hover:bg-purple-600 rounded px-2 py-1"
                    >
                      Duplicar
                    </button>
                  </div>

                  <button
                    (click)="handleOpenEpiphanyModalForCard(card.id, 'NEUTRAL_FORBIDDEN')"
                    class="epiphany-button absolute top-1 right-1 p-1 rounded-full text-xs font-bold shadow-md bg-yellow-500 hover:bg-yellow-400 transition"
                    [class.bg-yellow-500]="status.isRegularOnly"
                    [class.bg-gradient-to-r]="status.isMixed"
                    [class.from-yellow-500]="status.isMixed"
                    [class.to-red-500]="status.isMixed"
                    [class.bg-red-500]="status.isDivineOnly"
                    [class.bg-gray-400]="!status.hasLogs"
                  >
                    <span
                      class="text-black"
                      [class.text-white]="status.hasDivine || !status.hasLogs"
                      >‚ú®</span
                    >
                  </button>
                </div>
              } @else if (card.type === 'MONSTER') {
                <div
                  class="bg-zinc-500 p-3 rounded-lg relative group transition border border-zinc-400"
                >
                  <span class="font-bold text-sm">Monstruo</span>
                  <span class="block text-xs text-gray-300"
                    >+{{ FAINT_MEMORY_CONTRIBUTION[card.type] }} FM</span
                  >
                  <div class="flex gap-2 mt-2">
                    <button
                      (click)="removeDeckCard(card.id)"
                      class="flex-1 text-xs bg-red-800 hover:bg-red-700 rounded px-2 py-1"
                    >
                      Remover
                    </button>
                    <button
                      (click)="duplicateCard(card.id)"
                      class="flex-1 text-xs bg-purple-700 hover:bg-purple-600 rounded px-2 py-1"
                    >
                      Duplicar
                    </button>
                  </div>

                  <button
                    (click)="handleOpenEpiphanyModalForCard(card.id, 'MONSTER')"
                    class="epiphany-button absolute top-1 right-1 p-1 rounded-full text-xs font-bold shadow-md bg-yellow-500 hover:bg-yellow-400 transition"
                    [class.bg-yellow-500]="status.isRegularOnly"
                    [class.bg-gradient-to-r]="status.isMixed"
                    [class.from-yellow-500]="status.isMixed"
                    [class.to-red-500]="status.isMixed"
                    [class.bg-red-500]="status.isDivineOnly"
                    [class.bg-gray-400]="!status.hasLogs"
                  >
                    <span
                      class="text-black"
                      [class.text-white]="status.hasDivine || !status.hasLogs"
                      >‚ú®</span
                    >
                  </button>
                </div>
              } @else if (card.type === 'BASIC') {
                <div
                  class="bg-yellow-600 p-3 rounded-lg relative group transition border border-yellow-400"
                >
                  <span class="font-bold text-sm">B√ÅSICA</span>
                  <span class="block text-xs text-gray-900"
                    >+{{ FAINT_MEMORY_CONTRIBUTION[card.type] }} FM</span
                  >
                  <button
                    (click)="convertCard(index)"
                    class="px-3 py-1 mt-2 w-full bg-green-700 hover:bg-green-600 rounded text-sm transition disabled:opacity-50 font-medium"
                  >
                    Convertir a neutral
                  </button>

                  <div class="flex gap-2 mt-2">
                    <button
                      (click)="removeDeckCard(card.id)"
                      class="flex-1 text-xs bg-red-800 hover:bg-red-700 rounded px-2 py-1"
                    >
                      Remover
                    </button>
                    <button
                      (click)="duplicateCard(card.id)"
                      class="flex-1 text-xs bg-purple-700 hover:bg-purple-600 rounded px-2 py-1"
                    >
                      Duplicar
                    </button>
                  </div>
                </div>
              } @else if (card.type === 'UNIQUE') {
                <div
                  class="bg-blue-400 p-3 rounded-lg relative group transition border border-blue-300"
                >
                  <span class="font-bold text-sm">√öNICA</span>
                  <span class="block text-xs text-gray-900"
                    >+{{ FAINT_MEMORY_CONTRIBUTION[card.type] }} FM</span
                  >
                  <div class="flex gap-2 mt-2">
                    <button
                      (click)="removeDeckCard(card.id)"
                      class="flex-1 text-xs bg-red-800 hover:bg-red-700 rounded px-2 py-1"
                    >
                      Remover
                    </button>
                    <button
                      (click)="duplicateCard(card.id)"
                      class="flex-1 text-xs bg-purple-700 hover:bg-purple-600 rounded px-2 py-1"
                    >
                      Duplicar
                    </button>
                  </div>

                  <button
                    (click)="handleOpenEpiphanyModalForCard(card.id, 'UNIQUE')"
                    class="epiphany-button absolute top-1 right-1 p-1 rounded-full text-xs font-bold shadow-md bg-yellow-500 hover:bg-yellow-400 transition"
                    [class.bg-yellow-500]="status.isRegularOnly"
                    [class.bg-gradient-to-r]="status.isMixed"
                    [class.from-yellow-500]="status.isMixed"
                    [class.to-red-500]="status.isMixed"
                    [class.bg-red-500]="status.isDivineOnly"
                    [class.bg-gray-400]="!status.hasLogs"
                  >
                    <span
                      class="text-black"
                      [class.text-white]="status.hasDivine || !status.hasLogs"
                      >‚ú®</span
                    >
                  </button>
                </div>
              }
            }
          </div>
        }
      </div>

      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end justify-between">
        <button
          (click)="handleOpenAddCardModal()"
          class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition font-medium shadow-md"
        >
          ‚ûï A√±adir Carta al Deck
        </button>
      </div>
    </div>

    <div class="md:col-span-1 bg-gray-900 rounded-lg p-4 border border-gray-700 space-y-4">
      <h3 class="text-lg font-semibold mb-2 text-purple-300">Historial de FM (Solo Relevante)</h3>
      <div class="max-h-80 overflow-y-auto pr-2">
        @if (character().history.length === 0) {
          <p class="text-gray-500 italic text-sm">El historial de puntuaci√≥n se mostrar√° aqu√≠.</p>
        } @else {
          @for (entry of character().history.slice().reverse(); track $index) {
            <div
              class="flex justify-between items-center py-2 border-b border-gray-800 last:border-b-0 text-sm"
            >
              <span class="text-gray-400 font-light">{{ entry.description }}</span>
              <div class="flex gap-4">
                <span
                  [class.text-green-400]="entry.points > 0"
                  [class.text-red-400]="entry.points < 0"
                  class="font-mono w-16 text-right font-semibold"
                >
                  {{ entry.points > 0 ? '+' : '' }}{{ entry.points }}
                </span>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </div>

  <div class="pt-4 flex flex-col items-end gap-y-2 xl:flex-row xl:justify-end xl:gap-x-4">
    <button
      (click)="removeCharacter()"
      class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition font-medium"
    >
      üóëÔ∏è Eliminar Personaje
    </button>
  </div>
</div>
