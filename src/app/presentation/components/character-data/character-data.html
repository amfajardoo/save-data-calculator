<div
  class="bg-slate-900 rounded-lg border border-slate-700 shadow-xl overflow-hidden flex flex-col"
  [style.max-height]="'calc(100vh - 120px)'"
>
  <div
    class="px-2 py-1.5 flex items-center justify-between border-b bg-cover bg-center shrink-0 min-h-20"
  >
    <img
      class="max-h-20 w-full object-cover"
      [src]="character().character.portraitUrl"
      [alt]="character().character.name"
    />
  </div>

  <div class="p-2 space-y-2 overflow-y-auto flex-1 custom-scrollbar">
    <div>
      <div class="flex items-center justify-between mb-2 gap-2 flex-wrap sm:flex-nowrap">
        <h3 class="text-sm font-semibold text-slate-400 uppercase">
          Deck ({{ character().deck.length }})
        </h3>
        <div class="flex items-center gap-2">
          <span class="text-base font-bold text-purple-200 whitespace-nowrap uppercase"
            >FM: {{ character().score }} / {{ totalCap() }}</span
          >
        </div>
        <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
          <button
            (click)="handleOpenAddCardModal()"
            class="px-2 py-1.5 bg-indigo-600 hover:bg-indigo-700 rounded text-sm flex items-center gap-1 transition font-medium whitespace-nowrap"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M5 12h14"></path>
              <path d="M12 5v14"></path>
            </svg>
            <span class="hidden sm:inline">Añadir Carta</span>
            <span class="sm:hidden">Añadir</span>
          </button>
          <button
            (click)="removeCharacter()"
            class="px-2 py-1.5 bg-rose-600 hover:bg-rose-700 rounded text-sm flex items-center gap-1 transition font-medium whitespace-nowrap"
            title="Eliminar personaje"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            <span class="hidden sm:inline">Eliminar Personaje</span>
            <span class="sm:hidden">Eliminar</span>
          </button>
        </div>
      </div>

      @if (character().deck.length > 0) {
        <div class="grid grid-cols-4 gap-1 mb-1.5">
          @for (card of character().deck; track card.id; let index = $index) {
            @let status = getEpiphanyStatus(card);

            <div class="grid mb-3">
              <div
                class="relative rounded p-1 shadow-sm group hover:shadow-md transition-all bg-cover bg-center min-h-48 aspect-auto"
                [style.background-image]="'url(' + card.imgUrl + ')'"
              >
                @if (status.isMixed) {
                  <div
                    class="absolute top-1 right-1 w-7 h-7 rounded-full border-2 border-slate-900 bg-linear-to-br from-yellow-400 to-fuchsia-500 flex items-center justify-center shadow-lg z-10"
                    title="Epifanía Regular y Divina"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      class="text-white"
                    >
                      <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                      />
                    </svg>
                  </div>
                } @else if (status.isDivineOnly) {
                  <div
                    class="absolute top-1 right-1 w-7 h-7 rounded-full border-2 border-slate-900 bg-fuchsia-500 flex items-center justify-center shadow-lg z-10"
                    title="Epifanía Divina"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      class="text-white"
                    >
                      <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                      />
                    </svg>
                  </div>
                } @else if (status.isRegularOnly) {
                  <div
                    class="absolute top-1 right-1 w-7 h-7 rounded-full border-2 border-slate-900 bg-yellow-400 flex items-center justify-center shadow-lg z-10"
                    title="Epifanía Regular"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      class="text-slate-900"
                    >
                      <path
                        d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"
                      />
                    </svg>
                  </div>
                }
                @if (card.isDuplicate) {
                  <div
                    class="absolute top-1 left-1 w-7 h-7 rounded-full border-2 border-slate-900 bg-linear-to-br from-purple-400 to-purple-500 flex items-center justify-center shadow-lg z-10"
                    title="Replica"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                    </svg>
                  </div>
                }
              </div>
              <div class="flex flex-col">
                <div class="mb-1 px-1 py-1 min-h-10 flex items-center justify-center">
                  <span
                    class="text-xs font-bold text-white uppercase leading-tight text-center line-clamp-2"
                    >{{ card.name }}</span
                  >
                </div>

                <div class="flex gap-0.5 mb-1">
                  <button
                    (click)="removeDeckCard(card.id)"
                    title="Remover"
                    class="flex-1 bg-red-600 hover:bg-red-700 rounded px-1 py-1.5 transition flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    </svg>
                  </button>
                  <button
                    (click)="duplicateCard(card.id)"
                    title="Duplicar"
                    class="flex-1 bg-indigo-600 hover:bg-indigo-700 rounded px-1 py-1.5 transition flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                    </svg>
                  </button>
                  <button
                    (click)="
                      handleOpenEpiphanyModalForCard(
                        card.id,
                        card.type === 'MONSTER'
                          ? 'MONSTER'
                          : card.type === 'UNIQUE'
                            ? 'UNIQUE'
                            : 'NEUTRAL_FORBIDDEN'
                      )
                    "
                    title="Epifanía"
                    class="flex-1 bg-amber-500 hover:bg-amber-600 rounded px-1 py-1.5 transition flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      class="text-slate-900"
                    >
                      <path
                        d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"
                      />
                    </svg>
                  </button>
                </div>

                @if (card.type === 'BASIC') {
                  <button
                    (mousedown)="startConverting(index)"
                    (mouseup)="cancelConverting()"
                    (mouseleave)="cancelConverting()"
                    (touchstart)="startConverting(index)"
                    (touchend)="cancelConverting()"
                    class="w-full rounded px-1 py-1.5 text-xs transition font-medium text-white relative overflow-hidden"
                    [class.bg-teal-600]="convertingCardIndex() !== index"
                    [class.hover:bg-teal-700]="convertingCardIndex() !== index"
                  >
                    @if (convertingCardIndex() === index) {
                      <div
                        class="absolute inset-0 bg-gray-300 transition-all"
                        [style.width.%]="convertProgress()"
                      ></div>
                    }
                    <span class="relative z-10">→ Neutral</span>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>

    <div class="bg-slate-800 rounded p-1.5 border border-slate-700">
      <h3 class="text-sm font-semibold text-slate-400 mb-1 uppercase">Historial</h3>
      <div class="space-y-0.5 max-h-28 overflow-y-auto pr-1 custom-scrollbar">
        @if (character().history.length === 0) {
          <p class="text-sm text-slate-500 italic">Sin historial</p>
        } @else {
          @for (entry of character().history.slice().reverse(); track $index) {
            <div
              class="flex justify-between items-center text-sm border-b border-slate-700 pb-0.5 last:border-0 gap-2"
            >
              <span class="text-slate-400 truncate flex-1">{{ entry.description }}</span>
              <span
                class="font-mono font-semibold whitespace-nowrap"
                [class.text-emerald-400]="entry.points > 0"
                [class.text-rose-400]="entry.points < 0"
                [class.text-slate-400]="entry.points === 0"
              >
                {{ entry.points > 0 ? '+' : '' }}{{ entry.points }}
              </span>
            </div>
          }
        }
      </div>
    </div>
  </div>
</div>
